<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KFZ-Angebots-Konfigurator</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        h1, h2 { color: #333; }
        #totalPrice { color: #007bff; }
        label { margin-left: 8px; cursor: pointer; }
        input[type="checkbox"] { margin-right: 5px; }
        hr { border: 0; height: 1px; background: #ccc; margin: 20px 0; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üõ†Ô∏è Angebots-Konfigurator</h1>
    <p>Leistungen und Preise werden automatisch aus der Datei **Daten.csv** geladen.</p>
    
    <div id="statusMessage" class="success" style="margin-top: 10px;">Daten werden geladen...</div>

    <hr>

    <h2>1. Fahrzeugart w√§hlen:</h2>
    <select id="vehicleFilter" disabled>
        <option value="">-- Fahrzeugart ausw√§hlen --</option>
        </select>
    
    <div id="servicesContainer" style="margin-top: 30px;">
        <h2>2. Leistungen ausw√§hlen:</h2>
        <p id="promptText">Bitte warten, bis die Daten geladen sind...</p>
        </div>
    
    <hr>

    <h2 style="margin-top: 20px;">3. Gesamtpreis (Netto):</h2>
    <div id="totalPrice" style="font-size: 1.8em; font-weight: bold; color: #007bff;">‚Ç¨ 0,00</div>

<script>
    const CSV_FILE_PATH = 'Daten.csv'; // <--- Pfad zur CSV-Datei
    
    const vehicleFilter = document.getElementById('vehicleFilter');
    const servicesContainer = document.getElementById('servicesContainer');
    const totalPriceDisplay = document.getElementById('totalPrice');
    const statusDiv = document.getElementById('statusMessage');
    
    let allPriceData = [];

    // Event-Listener f√ºr den Filter
    document.getElementById('vehicleFilter').addEventListener('change', filterAndDisplayServices);
    
    // === Step 1: Daten automatisch laden (ersetzt den File-Upload) ===
    async function loadDataFromCSV() {
        try {
            const response = await fetch(CSV_FILE_PATH);
            if (!response.ok) {
                throw new Error(`Konnte die Datei nicht laden: Status ${response.status}`);
            }
            const csvText = await response.text();
            processData(csvText);
        } catch (error) {
            statusDiv.className = 'error';
            statusDiv.textContent = `FEHLER: ${error.message}. Ist die Datei "${CSV_FILE_PATH}" im Root-Verzeichnis vorhanden?`;
            vehicleFilter.disabled = true;
        }
    }
    
    // Funktion, die die Daten aus dem CSV-Text verarbeitet
    function processData(csvText) {
        const lines = csvText.split(/\r\n|\n/);
        allPriceData = [];
        const vehicleTypes = new Set();
        let isValidData = false;

        // Die erste Zeile (√úberschriften) wird √ºbersprungen (i=1)
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const separator = line.includes(';') ? ';' : ',';
            const columns = line.split(separator).map(col => col.trim().replace(/"/g, ''));

            // Wir erwarten Artikelnummer, Dienstleistung, Fahrzeugart, Preis Netto
            if (columns.length >= 4) {
                const priceNetto = parseFloat(columns[3].replace(',', '.'));
                
                allPriceData.push({
                    artikelnummer: columns[0],
                    dienstleistung: columns[1],
                    fahrzeugart: columns[2],
                    preisNetto: priceNetto
                });
                vehicleTypes.add(columns[2]);
                isValidData = true;
            }
        }

        if (isValidData) {
            statusDiv.className = 'success';
            statusDiv.textContent = `Daten erfolgreich aus "${CSV_FILE_PATH}" geladen.`;
            populateVehicleFilter(vehicleTypes);
        } else {
            statusDiv.className = 'error';
            statusDiv.textContent = 'FEHLER: Keine g√ºltigen Daten in der CSV-Datei gefunden.';
            vehicleFilter.disabled = true;
        }
    }

    // === Step 2: Dropdown-Liste mit Fahrzeugarten f√ºllen ===
    function populateVehicleFilter(vehicleTypes) {
        vehicleFilter.innerHTML = '<option value="">-- Fahrzeugart ausw√§hlen --</option>';
        vehicleTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            vehicleFilter.appendChild(option);
        });
        vehicleFilter.disabled = false;
        servicesContainer.querySelector('#promptText').textContent = 'Bitte w√§hlen Sie eine Fahrzeugart, um die Leistungen zu sehen.';
    }

    // === Step 3: Filtern und Checkboxen anzeigen ===
    function filterAndDisplayServices() {
        const selectedVehicle = vehicleFilter.value;
        
        // L√∂schen aller Elemente, au√üer der √úberschrift (falls vorhanden)
        const currentElements = servicesContainer.querySelectorAll(':not(h2)');
        currentElements.forEach(el => el.remove());
        totalPriceDisplay.textContent = '‚Ç¨ 0,00'; // Gesamtpreis zur√ºcksetzen

        if (!selectedVehicle) {
            servicesContainer.innerHTML += '<p id="promptText">Bitte w√§hlen Sie eine Fahrzeugart, um die Leistungen zu sehen.</p>';
            return;
        }

        const filteredServices = allPriceData.filter(item => item.fahrzeugart === selectedVehicle);
        
        filteredServices.forEach(item => {
            const checkboxId = `service-${item.artikelnummer}`;
            
            const div = document.createElement('div');
            div.style.marginBottom = '10px';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = checkboxId;
            checkbox.value = item.preisNetto;
            checkbox.addEventListener('change', calculateTotal);
            
            const label = document.createElement('label');
            label.htmlFor = checkboxId;
            label.textContent = `${item.dienstleistung} (${formatPrice(item.preisNetto)} Netto)`;

            div.appendChild(checkbox);
            div.appendChild(label);
            servicesContainer.appendChild(div);
        });
    }

    // === Step 4: Gesamtpreis berechnen ===
    function calculateTotal() {
        let total = 0;
        const selectedCheckboxes = servicesContainer.querySelectorAll('input[type="checkbox"]:checked');
        
        selectedCheckboxes.forEach(checkbox => {
            total += parseFloat(checkbox.value);
        });

        totalPriceDisplay.textContent = formatPrice(total);
    }
    
    // Hilfsfunktion zur Preisformatierung
    function formatPrice(amount) {
        return amount.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });
    }

    // Startet den Ladevorgang, wenn die Seite fertig geladen ist
    loadDataFromCSV();
</script>
</body>
</html>
